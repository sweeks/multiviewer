#!/usr/bin/env bash
set -euo pipefail
# pre-commit fails if validate-repo fails or if validate-repo modifies any staged file.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

staged_files="$(git diff --cached --name-only)"
pre_ix_hash="$(git diff --cached --no-color | git hash-object --stdin)"

"$ROOT/bin/validate-repo.sh"

post_ix_hash="$(git diff --cached --no-color | git hash-object --stdin)"
if [[ "$pre_ix_hash" != "$post_ix_hash" ]]; then
  echo "pre-commit: validation modified staged files; review/stage and re-run" >&2
  exit 1
fi
